---
layout: post
title: 区块链技术
tag: 技术笔记
date: 2020-4-25
category: Technology blog
---
#### 什么是区块链

区块链是一个信息技术领域的术语。从本质上讲，它是一个共享数据库，存储于其中的数据或信息，具有“不可伪造”“全程留痕”“可以追溯”“公开透明”“集体维护”等特征。基于这些特征，区块链技术奠定了坚实的“信任“基础，创造了可靠的“合作”机制，具有广阔的运用前景。

区块连起源于比特币，2008年11月1日，一位自称中本聪的人发表了《比特币:一种点对点的电子现金系统》一文，阐述了基于P2P网络技术、加密技术、时间戳技术、区块链技术等的电子现金系统的构架理念，这标志着比特币的诞生。两个月后理论步入实践，2009年1月3日第一个序号为0的创世区块诞生。几天后2009年1月9日出现序号为1的区块，并与序号为0的创世区块相连接形成了链，标志着区块链的诞生

区块链是一个分布式的共享账本和数据库，具有去中心化、不可篡改、全程留痕、可以追溯、集体维护、公开透明等特点。这些特点保证了区块链的“诚实”与“透明”，为区块链创造信任奠定基础。而区块链丰富的应用场景，基本上都基于区块链能够解决信息不对称问题，实现多个主体之间的协作信任与一致行动，是分布式数据存储，点对点传输，共识机制，加密算法等计算机技术的新型应用模型，区块链，是比特币的一个重要概念，本质上是一个去中心化的数据库。其特点是，去中心化、公开透明，作为分布式账本技术，每个节点都可以参与数据库的记录。

区块链是一个注重安全和可信度胜过效率的一项技术，如果说是互联网技术解决的是通讯问题，区块链技术则解决的是信任问题。

那么，在区块链技术当中，作为分布式账本，每个参与者都维护了一份数据，那么如何确认记账权，最终的账本以谁为准呢？

#### 区块链的共识

区块链是一种去中心化的分布式账本系统，区块链的共识问题实际上是来源于分布式系统的一致性问题，且共识，顾名思义即指共同的认识，共识问题研究的是多个成员如何达成一致，典型的比如投票选举，共识机制在区块链中扮演着核心地位，共识机制决定了谁有记账的权力，以及记账权力的选择过程以及理由，不同的虚拟货币采用的共识机制也是不同的，常见的共识机制有POW、POS、DPOS等。

我们前面提到的CAP中的C是Consistency（一致性），Consistency和Consensus有什么区别呢？

Consistency侧重的是内容在时间顺序上一致和统一，而Consensus则是指有许多参与者对某项内容达成共识，所以一般吧Consistency翻译为“一致性”，把Consensus翻译为“共识”。

#### 拜占庭将军问题

如果把共识机制延伸到分布式系统中，就是系统需要有一个主进程来协调，系统的所有决定都是有主进程来达成一致性，到了区块链，由于区块链是一种去中心化的分布式系统，所以区块链中是没有类似与团队里的leader，以及分布式系统中的master角色的，这样就需要有某种共识机制，以便保证系统一致性。

一般在网络通信中，把节点故障，也就是信道不可靠的情况称为“非拜占庭错误”，恶意响应，也就是系统被攻击，传递错误消息称为“拜占庭错误”

在拜占庭问题里，各领国最终的事情是，所有将军如何能够达成共识去攻打拜占庭帝国。拜占庭将军问题核心描述是军中可能有叛徒，却要保证进攻一致，由此引申到计算机邻域，发展成了一种容错理论：

一群将军想要实现某一个目标，比如一直进攻或者一直撤退，单独行动是行不通的，必须合作，达成共识；由于叛徒的存在，将军们不知道因该如何达成一致，其实，拜占庭将军问题和我们前面提到的Paxos算法，逻辑时钟等，都是由Leslie Lamport提出的。

在记账权的归属中，关键是如何避免恶意共识的出现，也就是错误的记账，类似如何处理拜占庭将军中的叛徒。

比特币是区块链技术最广泛的应用，在比特币如何决定记账权呢？答案就是POW机制，接下来我们来分析POW工作量的证明机制。

#### POW工作量证明

POW被认为是经过验证最安全的拜占庭解决机制，最早是用来防垃圾邮件的，典型就是Google邮箱的反垃圾邮件系统。

Google邮箱强制要求每一个给Google服务器发送邮件的发送者，必须先完成一定量的计算工作，造成一小段时间的延迟，比如延迟1秒，如果是正常的邮件发送，这个时间是可以接受；如果是广告邮件发送者，因为要进行大量的发送工作，这种无价值的计算是无法忍受的

简单理解就是一份证明，用来确认你做过一定量的工作。监测工作的整个过程通常是极为低效的，而通过对工作的结果进行认证来证明完成了相应的工作量，则是一种非常高效的方式。比如现实生活中的毕业证、驾驶证等等，也是通过检验结果的方式（通过相关的考试）所取得的证明。

工作量证明系统（或者说协议、函数），是一种应对拒绝服务攻击和其他服务滥用的经济对策。它要求发起者进行一定量的运算，也就意味着需要消耗计算机一定的时间。这个概念由Cynthia Dwork 和Moni Naor 1993年在学术论文中首次提出。而工作量证明（POW）这个名词，则是在1999年 Markus Jakobsson 和Ari Juels的文章中才被真正提出。

#### 挖矿的由来

挖矿是比特币系统中一个形象化的表达，把么挖矿是怎么来的呢？

比特币挖矿是将一段时间内比特币系统中发生的交易进行确认，并记录在区块链上形成新区块的过程，由于需要竞争记账权，利用计算机去计算Hash数值，随机碰撞解题，这个过程就是挖矿。

换句话说，就是比特币系统出一道数学题，大家抢答最优解，挖矿就是记账的过程，矿工是记账员，区块链就是账本。

#### 比特币POW的实现

比特币的POW实现，使用过计算来猜测一个数值（Nonce），得以解决规定的Hash问题，下面是比特币的区块结构，可以看到区块头有个随机数字段，这个就是Nonce值：


中本聪在比特币系统中设置了一道题目，通过不断调节Nonce的值，来对区块头算Hash，要求找到一个Nonce值，使得算出来的Hash值满足某个固定值。

具体的Hash算法一般是使用的是SHA256算法

SHA256算法中使用到了8个哈希初始值以及64个哈希常量，其中SHA256算法的8个哈希初值如下：

```
h0 := 0x6a09e667
h1 := 0xbb67ae85
h2 := 0x3c6ef372
h3 := 0xa54ff53a
h4 := 0x510e527f
h5 := 0x9b05688c
h6 := 0x1f83d9ab
h7 := 0x5be0cd19
```

这些初值是对自然数中前8个质数（2，3，5，7，11，13，17，19）的平方根的小数部分取前32bit而来，举个例子说，$、sqrt{2}$小数部分约为0.414213562373095048，而0.414213562373095048 约等于 6 * 16^-1 + a * 16^-2 + 0 *  16 ^-3 + ... 于是，质数2的平方根的小数部分取前32bit就对应出了0x6a09ee667

在SHA256算法中，用到的64个常量如下

```
428a2f98 71374491 b5c0fbcf e9b5dba5
3956c25b 59f111f1 923f82a4 ab1c5ed5
d807aa98 12835b01 243185be 550c7dc3
72be5d74 80deb1fe 9bdc06a7 c19bf174
e49b69c1 efbe4786 0fc19dc6 240ca1cc
2de92c6f 4a7484aa 5cb0a9dc 76f988da
983e5152 a831c66d b00327c8 bf597fc7
c6e00bf3 d5a79147 06ca6351 14292967
27b70a85 2e1b2138 4d2c6dfc 53380d13
650a7354 766a0abb 81c2c92e 92722c85
a2bfe8a1 a81a664b c24b8b70 c76c51a3
d192e819 d6990624 f40e3585 106aa070
19a4c116 1e376c08 2748774c 34b0bcb5
391c0cb3 4ed8aa4a 5b9cca4f 682e6ff3
748f82ee 78a5636f 84c87814 8cc70208
90befffa a4506ceb bef9a3f7 c67178f2
```

我们来简化一下计算过程，假设第100个区块给出的区块值是下列字符串，最早计算出该字符串的节点可以获得比特币：

```
f7684590e9c732fb3cf4bf0b8e0f5ea9511e8bbaacb589892634ae7938e5700c
```

由于Hash算法是一个不可以逆的算法，没法通过具体的Hash值倒推出原文，这样每个节点只能采用穷举的方法，也就是选择各种字符串，比如开始的a、b、c、1、2、3、..这样不断地尝试。

比特币系统自身会调节难度，控制解题的时间，一般来讲，约每10分钟挖出一个区块，在这10分钟内，计算机只能不停地去计算，去试各种字符串。

这个过程实际上是考研各个节点的服务器性能，也就是算力，如果你算力非常强大，有几万台服务器，可以很快得到Nonce值，也就是正确答案，lagou，对应Hash值和题目要求一致，接下来你就可以把这个Nonce值放在结构体，通过P2P网络广播出去，其他的系统节点收到后，发现这个Nonce值是合法的，能满足要求，会认为你挖矿成功。

由于解出了题目，你会获得系统对应的比特币奖励，以及本区块内所有交易产生的手续费。其他节点发现有人已经算出来了，就会放弃本次计算，然后开启下一个区块的题目，去寻找下一个区块头的 Nonce 值。

#### 区块链分叉和51%攻击

Hash问题具有不可逆的特点，主要依靠暴力计算，谁的算力多，谁最先解决问题的概率就越大，当掌握超过全网一般算力时，就能控制网络中链的走向，这就是所谓51%的攻击的由来，简而言之，就是网络中有人的算力超过了全网的51%，导致主链出现分叉甚至被替代，但这种攻击仅存在与理论情况，想要掌控全网51%的算力，这将是一个非常大的投资

前面我们说过，因为区块链中每个节点都可以参与记账，系统中可能出现链的分叉（Fork），最终会有一条链成为最长的链

POW机制优缺点

POW 的优点有很多，POW 是第一个完全实现去中心化共识算法的，并且节点自由进出，容易实现，由于对算力的高要求，破坏系统花费的成本也巨大。

POW 机制的缺点也是显而易见的，最大的就是浪费能源，巨大的算力被浪费在了无尽的挖矿行为中，并且本身并不产生任何价值。

这也是区块链被很多人指责的一点，浪费了大量的能源，收获的仅仅是一堆无价值的数据存储，换个角度来思考，这也说明了在去中心化的场景下，实现信任是多么的困难。

另一方面可以看到，大量的数字货币矿场都是建设在西南地区的深山中，利用当地价格低廉的电力资源，或者就直接和发电站建设在一起。

> 引用：
>
> [深度解析 区块链攻击大法之51%攻击-区块链币圈](https://www.jianshu.com/p/d6be6637edc1)
>
>  [区块链共识算法-POW    wycandyy](https://www.jianshu.com/p/b23cbafbbad2)
>
> [百度百科：区块链]([https://baike.baidu.com/item/%E5%8C%BA%E5%9D%97%E9%93%BE/13465666?fr=aladdin](https://baike.baidu.com/item/区块链/13465666?fr=aladdin))
>
> [分布式技术原理与实战45讲》- 蒋越](https://kaiwu.lagou.com/course/courseInfo.htm?courseId=69#/content)
>
> [SHA256算法详解 随煜而安](https://blog.csdn.net/u011583927/article/details/80905740)

