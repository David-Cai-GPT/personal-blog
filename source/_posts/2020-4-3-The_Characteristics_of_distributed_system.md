---
layout: post
title: 分布式（一）分布式系统的特点与CAP
tag: 技术笔记
date: 2020-4-3
category: Technology blog
---
#### 分布式系统的特点

分布式系统时间里在网络之上的硬件或者软件系统，彼此之间通过消息等方式进行通信和协调，其核心是可扩展性，通过对服务，存储的扩展，来提高系统的处理能力，除了对可扩展性的需求，分布式系统还有不出现单点故障，服务或者存储无状态等特点

> 单点故障（Single Point Failure）是指在系统中某个组件一旦失效，这会让整个系统无法工作，而不出现单点故障，单点不影响整体，就是分布式系统的设计目标之一；
>

> 无状态，是因为无状态的服务才能满足部分机器宕机不影响全部，可以随时进行扩展的需求。

#### CAP理论

CAP理论可以表述为，一个分布式系统最多只能同时满足一致性（Consistency）、可用性（Availability）和分区容忍性（Partition Tolerance） 这第三项中的两项

![Ciqah16ER_SAGmCqAADG3jNX34o901](Ciqah16ER_SAGmCqAADG3jNX34o901.png)

**一致性**是指“所有节点同时看到相同的数据”，即更新操作成功并返回客户端完成后，所有节点在同一时间的数据完全一致，等用于所有节点拥有数据的最新版本

**可用性**是指“任何时候，读写都是成功的”，即服务一直可用，而且是正常响应时间（系统稳定性描述SLA，即服务水平协议）

**分区容忍性**具体是指“当部分节点出现消息丢失或者分区故障的时候，分布式系统任然能够继续运行”，即系统容忍网络出现分区，并且在遇到某个节点或网络分区之间网络不可达的情况下，任然能够对外提供满足一致性和可用性服务

在分布式系统中，由于系统的各层拆分，P是确定的，CAP的应用模型就是CP架构和AP架构，分布式系统所关注的，就是在Partition Tolerance的前提下，如何实现更好的A，和更稳定的C。

#### CAP理论的应用

在架构设计中，不要把精力浪费在如何设计能满足三者的完美分布式系统上，而要合理的进行取舍，CAP理论类似数学上的不可能三角，只能三者选其二，不能全部获得，需要对不同的业务进行评估，选择最合适的架构

CP架构：对于CP来说，放弃可用性，追求一致性和分区容错性

我们熟悉的ZooKeeper，就是采用了CP一致性，ZooKeeper是一个分布式的服务框架，主要用来解决分布式集群中应用系统的协调和一致性问题，核心算法为Zab，所有设计都是为了一致性。在CAP模型中，ZooKeeper是CP，这意味着面对网络分区时，为了保证一致性，它是不可用的

AP架构：对于 AP 来说，放弃强一致性，追求分区容错性和可用性，这是很多分布式系统设计时的选择。

和ZooKeeper相对的是Eureka，Eureka是SpringCloud微服务技术栈中的服务发现组件，Eureka的各个节点都是平等的，几个节点挂掉不影响正常节点的工作，剩余的节点依然可以提供注册和查询服务，只要有一台 Eureka 还在，就能保证注册服务可用，只不过查到的信息可能不是最新的版本，不保证一致性。

对于CAP来说，放弃强一致性，追求分区容错性和可用性，这是很多分布式系统设计时的选择。在工程实践中，基于CAP定理的逐步演化，就提出了Base理论。

##### Base理论

Base是三个短语的简写，即基本可用（Basically Available）、软状态（Soft State）和最终一致性（Eventually Consistent）。

![Ciqah16FrueAWLATAABOyQi2X3M251](Ciqah16FrueAWLATAABOyQi2X3M251.png)

其理论的核心思想是最终一致性，并不是强一致性，每个应用根据自身的业务特点，采用适当的方式达到最终一致性

##### Base三个要素详解

**基本可用**：不追求CAP中的【任何时候，读写都是成功的】，而是系统能够基本运行，一直提供服务，基本可用强调了分布式系统在出现不可预知故障的时候，允许损失部分可用性，相比正常的系统，可能是响应时间延长，或者是服务被降级

**软状态**：软状态可以对应ACID事务（一种强一致性模型，强调原子性、一致性、隔离性、持久性主要用于在数据库实现当中）中的原子性，在ACID的事务中，实现的是强制一致性，要么全做要么不做，所有用户看到的数据一致，其中的原子性要求多个节点的数据副本都是一致的，强调数据的一致性

**最终一致性**：数据不可能一直是软状态，必须在一个时间期限之后达到各个节点的一致性，在期限过后，应当保证所有副本数据一致性，也就是达到数据的最终一致性

##### 全局时钟和逻辑时钟

分布式系统解决了传统单体架构的单点问题和性能容量问题，另一方面也带来了很多新的问题，其中一个问题就是多节点的事件同步问题，不同机器上的物理时钟难以同步，导致无法区分在分布式系统中多个节点的事件时序，可以说没有全局时钟的内部一致性是没有意义的

和全局时钟相对的，是逻辑时钟，逻辑时钟描绘了分布式系统中时间发生的时序，是为了区分现实中的物理时钟提出来的概念

如果两个节点之间不进行交互，那么它们的时间甚至都不需要同步，因此问题的关键点在于结点间的交互要在事件的发生顺序上达成一致，而不是对于时间达成一致

##### 不同数据一致性模型

数据一致性模型可以分为强一致性和弱一致性，强一致性也叫做线性一致性，除此之外，所有其他的一致性都是弱一致性的特殊情况，弱一致性根据不同的业务场景，又可以分解为更细分的模型

在互联网邻域的绝大多数场景中，都需要牺牲强一致性来换取系统的高可用性，系统往往只需要保证“最终一致性”

![Ciqah16FruiAGz3eAAIrOBxKnpU229](Ciqah16FruiAGz3eAAIrOBxKnpU229.png)

##### 强一致性

当更新操作完成之后，任何多个后续进程的访问都会返回最新的值，这种是对用户最友好的，就是用户上一次写什么，下一次就保证能读到什么，根据CAP理论，这种就需要牺牲可用性

##### 弱一致性

系统在数据写入成功之后，不承诺立即可以读到最新写入的值，也不会具体的承诺多久之后可以读到，用户读到某一操作对系统数据的更新需要一段时间，我们称这段时间为“不一致性窗口”

##### 最终一致性

最终一致性是弱一致性的特例，强调的是所有的数据副本，再经过一段时间的同步之后，最终都能够达到一个一致性的状态，其根据不同的保证可以划分为更多的模型，包括因果一致性和会话一致性等

**因果一致性**因果一致性要求有因果关系的操作顺序得到保证，非因果关系的操作无所谓，进程A在更新完某个数据项后通知了进程B，那么进程B之后对该数据项的访问都应该能够获取到进程A更新后的最新值，并且如果进程B要对该数据项进行更新操作的话，务必基于进程A更新后的最新值

**会话一致性**会话一致性将对系统数据的访问过程框定在了一个会话当中，约定了系统能保证在同一个有效的会话中实现“读己之所写”的一致性，就是在你的一次访问中，执行更新操作之后，客户端能够在同一个会话中始终读取到该数据项的最新值

CAP及Base的关系

Base 理论是在 CAP 上发展的，CAP 理论描述了分布式系统中数据一致性、可用性、分区容错性之间的制约关系，当你选择了其中的两个时，就不得不对剩下的一个做一定程度的牺牲。

Base理论则是对CAP理论的实际应用，也就是在分区和副本存在的前提下，通过一定的系统设计方案，放弃强一致性，实现基本可用，这是大部分分布式系统的选择，比如NoSQL系统、微服务架构。在这个前提下，如何把基本可用的做到最好，就是分布式工程师们所追求的

> 参考学习讲师：邴越《分布式技术原理与实战45讲》笔记
>