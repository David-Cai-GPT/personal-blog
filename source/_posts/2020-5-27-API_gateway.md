---
layout: post
title: 分布式系统API网关
tag: 技术笔记
date: 2020-5-27
category: Technology blog
---
#### API网关

对网关我们并不陌生，网关的概念来源于计算机网络，表示不同网络之间的关口，在系统设计中，网关也是一个重要的角色，其中最典型的是各大公司的开放平台，开放平台类网管是企业内部系统对外的统一入口，承担了很多业务，比如内部外部数据交互、数据安全、监控统计等功能。

在微服务架构中，API网关的作用和开放平台等传统网关又有些不同。

#### 为什么需要网关

在微服务架构中，一个大应用被拆分成多个小的服务，这些微服务自成体系，可以独立部署和提供对外服务，一般来说，微服务调用规范主要有RPC和Restful API两种，API网关主要怕针对的是后面一种，也就是以Spring Cloud为代表的微服务解决方案。

#### 从一个实际场景入手

假设我i们要使用微服务构建一个电商平台，一般来说需要订单服务，商品服务，交易服务，评论服务，库存服务等。

移动互联网时代，我们系统不仅会通过Web端提供服务，还有APP端，小程序端，那么不同客户端应该如何访问这些服务呢？

如果在单体应用架构下， 所有服务都来自一个应用工程，客户端通过向服务端发起网络调用来获取数据，通过Nginx等负载均衡策略将请求路由给N个相同的应用程序实例中的一个，然后应用程序处理业务逻辑，并将响应返回给客户端。

![Ciqc1F7DuLWALZMDAAB1i-97j1c184](Ciqc1F7DuLWALZMDAAB1i-97j1c184.png)

在微服务架构下，每个服务都是独立部署，如果直接调用，系统设计可能是这样的：

![Ciqc1F7DuNqAJXtiAAC4PwBmfM0342](Ciqc1F7DuNqAJXtiAAC4PwBmfM0342.png)

各个调用单独去发起链接，会出现很多问题，比如不容易监控调用流量，出现问题不好确定来源，服务之间调用关系混乱等。

#### 如何解决这个局面呢？

针对这些问题，一个常用的解决方案是使用API服务网关，在微服务设计中，需要隔离内外部调用，统一进行系统鉴权、业务监控等，API服务网关是一个非常合适的切入口。

通过引入API网关这一角色，可以高效的实现微服务集群的输出，节约后端服务开发成本，减少上线风险，并为服务熔断，灰度发布，线上测试提供解决方案。

![CgqCHl7DuPuAH-1AAAE28Z6XTRo611](CgqCHl7DuPuAH-1AAAE28Z6XTRo611.png)

使用网关，可以优化微服务架构中系统过于分散的弊端，是的架构更加优雅，选择一个适合的API网关，可以有效地简化开发并提高运维与管理效率。

#### 应用网关的优劣

API网关在微服务架构中并不是一个必需项目，而是系统设计的一个解决方案，用来整个各个不同模块的微服务，统一协调服务。

API网关自身也是一个服务，网关封装了系统内部架构，为每个客户端提供了一个定制的API，从面向对象设计的角度看，它与外观模式类似，外观模式的定义是，外部与一个子系统的通信必须通过一个统一的外观对象进行，为子系统中的一组接口提供一个一致的界面，这一点和API网关的作用非常类似。

除了封装内部系统之外，API网关作为一个系统访问的切面，还可以添加身份验证、监控、负载均衡、限流、降级与应用检测等功能。

用过在微服务架构中引入API网关，可以带来以下的收益：

- API服务网关对外提供统一的入口供客户端访问，隐藏系统架构实现的细节，让微服务使用更为友好。
- 借助API服务网关可统一做切面任务，避免每个微服务自己开发，提升效率，是系统更加标准化；
- 通过API服务网关，可以将异构系统进行统一整合，比如外部API使用HTTP接口，内部微服务可以使用一些性能更高的通信协议，然后再网关中进行转换，提供统一的外部REST接口；
- 通过微服务的统一访问控制，可以更好的实现鉴权，提高系统的安全性。

API网关并不是一个必需的角色，在系统设计中引入网关，也会导致系统复杂性增加，带来下面的问题：

- 在发布和部署阶段需要管理网关的配置，保证外部API访问的是正常的服务实例；
- API服务网关需要实现一个高可用伸缩性强的服务，避免单点失败，否则会成为系统的瓶颈；
- 引入API服务网关额外添加了一个需要维护的系统，增加了开发和运维的工作量，提高了系统复杂程度。

可以看到，应用API网关需要权衡带来的收益和因此增加的复杂性，这也是我们前面说的，分布式系统是复杂性和收益的平衡，需要针对具体业务进行合理的架构设计。

#### 微服务选型

在微服务领域，有许多开源网管实现，应用比较多的是Spring Cloud Zuul 和Spring Cloud Gateway

#### Spring Cloud Zuul

Spring Cloud Zuul是Spring Cloud Netflix 项目的核心组件之一，是Netflix 开发的一款提供动态路由、监控、弹性、安全的网关服务。

Zuul分为1.x和2.x两个大版本，1.x版本是基于Servlet构建的，采用的是阻塞和多线程方式。1.x版本在Spring Cloud中做了比较好的集成，但是性能不是很理想，后来Netflix宣布开发了2.x版本，目前已经更新到了2.x版本，不过Spring Cloud官方并没有集成，而是开发了自己的Spring Cloud Gateway。

#### Spring Cloud Gateway

Spring Cloud Gateway 是Spring Cloud 体系的第二代网关组件，基于Spring 5.0的新特性WebFlux进行开发，底层网络通信框架使用的是Netty

Spring Cloud Gateway可以替代第一代的网关组件Zuul，Spring Cloud    Gateway可以通过服务发现自动转发请求，继承了Ribbon做负载均衡，支持使用Hystrix对网关进行保护，当然也可以选择其他的容错组件，比如集成阿里巴巴开源的Sentinel，实现更好的限流降级等功能。

##### 简化客户端调用复杂度

在微服务架构模式下后端服务实例数一般是动态的，对于客户端而言如何发现这些动态改变的服务实例的访问地址信息，因此在基于微服务的项目中为了简化前端逻辑，通常会引入API Gateway作为轻量级网关，同时API Gateway中也会实现相关的认证逻辑从而简化内部服务之间的相互调用的复杂度。

##### 数据裁剪以及聚合

通常而言多于不同的客户端对于显示时数据的需求是不一致的，比如手机端或者Web端又或者在低延迟的网络环境或者高延迟的网络环境。

因此为了优化客户端的使用体验，API Gateway可以对通用性响应数据进行裁剪以适应不同客户端的使用需求，同时还可以将多个API调用逻辑进行聚合，从而减少客户端的请求数，优化客户端的用户体验

##### 多渠道支持

当然我们还可以针对不同的渠道和客户端提供不同的API Gateway对于该模式的使用由另外一个大家熟知的方式叫Backend for front-end，我们可以针对不同的客户端分别创建其BFF。

##### 遗留系统的微服务化改造

对于系统而言进行微服务改造通常是由于原有的系统存在或多或少的问题，比如技术债务，代码质量，可维护性，可扩展性等等。API Gateway的模式同样适用于这一类遗留系统的改造，通过微服务化的改造逐步实现对原有系统中的问题的修复，从而提升对于原有业务响应力的提升。通过引入抽象层，逐步使用新的实现替换旧的实现。

> [分布式API网关Gateway](https://blog.csdn.net/weixin_40584932/article/details/81037436)
> [分布式技术原理与实战45讲](https://kaiwu.lagou.com/course/courseInfo.htm?courseId=69#/detail/pc?id=1913)